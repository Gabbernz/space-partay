<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Space Partay – Politikken</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Chat-spesifikk styling (bygger på din eksisterende) -->
  <style>
    /* Holder oss til samme mørke tema som main */
    .chat-shell {
      width: min(900px, 92vw);
      margin: 0 auto;
      text-align: left;
    }

    .chat-card {
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(6px);
    }

    .chat-header {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
    }

    .chat-header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.3px;
    }

    .chat-header p {
      margin: 6px 0 0;
      font-size: 13px;
      opacity: 0.85;
    }

    #chat {
      height: 58vh;
      overflow-y: auto;
      padding: 14px 14px 6px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg-wrap { display: flex; flex-direction: column; gap: 4px; }
    .meta { font-size: 12px; opacity: 0.75; }

    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      line-height: 1.35;
      border: 1px solid rgba(255,255,255,0.14);
    }

    .me {
      align-self: flex-end;
      background: rgba(56, 189, 248, 0.18);  /* matcher din button-farge-ish */
    }

    .bot {
      align-self: flex-start;
      background: rgba(255,255,255,0.06);
    }

    .inputRow {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.12);
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      resize: none;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color: white;
      font: inherit;
      outline: none;
    }

    .chat-input::placeholder { color: rgba(255,255,255,0.6); }

    .sendBtn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      background: #38bdf8;  /* bruker samme som din button */
      color: #0f172a;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .sendBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #status {
      font-size: 12px;
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      opacity: 0.9;
    }

    #status.error { color: #ff6b6b; opacity: 1; }

    /* Litt spacing siden body har margin-top: 80px fra style.css */
    .page-title {
      text-align: center;
      font-size: xxx-large;
      margin-bottom: 14px;
      letter-spacing: 2px;
    }
  </style>
</head>

<body>
  <div style="display:flex; justify-content: center; align-items: center; flex-direction: column;">
    <div>
      <header class="page-title">SPACE PARTAY</header>
    </div>

    <header>
      <div class="header-logo">
        <a href="/">
          <img src="{{ url_for('static', filename='logo.PNG') }}" class="logo">
        </a>
      </div>

      <div class="header-links">
        <a href="{{ url_for('member') }}" style="width: 15%; height: 25%; border-radius:5%; border-color: white; border-width: 1px; border-style: solid; padding: 1%;">
          Bli Medlem
        </a>
        <a href="{{ url_for('chat') }}" style="width: 15%; height: 25%; border-radius:5%; border-color: white; border-width: 1px; border-style: solid; padding: 1%;">
          Politikken
        </a>
        <a href="{{ url_for('omoss') }}" style="width: 15%; height: 25%; border-radius:5%; border-color: white; border-width: 1px; border-style: solid; padding: 1%;">
          Om oss
        </a>
      </div>
    </header>

    <main class="chat-shell">
      <div class="chat-card">
        <div class="chat-header">
          <h1>Snakk med vær kjære partileder Darleif Vederås!</h1>
          <p>Spør han spørsmål om alt! Han liker serlig godt å snakke om moderne problemer som produksjon av varer :)</p>
        </div>

        <div id="chat" aria-live="polite"></div>

        <div class="inputRow">
          <textarea id="input" class="chat-input" rows="2"
            placeholder="Skriv et spørsmål… (Enter = send, Shift+Enter = linjeskift)"></textarea>
          <button id="send" class="sendBtn">Send</button>
        </div>

        <div id="status"></div>
      </div>
    </main>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");

    function appendMessage(who, text) {
      const wrapper = document.createElement("div");
      wrapper.className = "msg-wrap";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = who === "me" ? "Du" : "Space Partay";
      wrapper.appendChild(meta);

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (who === "me" ? "me" : "bot");
      bubble.textContent = text;
      wrapper.appendChild(bubble);

      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;

      return bubble;
    }

    function setBusy(busy) {
      sendBtn.disabled = busy;
      inputEl.disabled = busy;
      statusEl.className = busy ? "" : statusEl.className;
      statusEl.textContent = busy ? "Svarer…" : "";
    }

    async function sendMessage() {
      const message = inputEl.value.trim();
      if (!message) return;

      appendMessage("me", message);
      inputEl.value = "";
      setBusy(true);

      const botBubble = appendMessage("bot", "");

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        // Hvis du endrer Flask til å returnere 402 på quota/billing-feil:
        if (res.status === 402) {
          const data = await res.json().catch(() => ({}));
          botBubble.textContent = data.answer || "API-billing/kreditt er ikke aktiv.";
          statusEl.textContent = "Billing/kreditt mangler";
          statusEl.className = "error";
          return;
        }

        if (!res.ok) {
          const errTxt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${errTxt}`);
        }

        const data = await res.json();
        botBubble.textContent = data.answer ?? "(tomt svar)";
        statusEl.textContent = "";
        statusEl.className = "";
      } catch (err) {
        console.error(err);
        botBubble.textContent = "Beklager — klarte ikke å hente svar fra serveren.";
        statusEl.textContent = "Feil: sjekk at Flask kjører og at /api/chat finnes.";
        statusEl.className = "error";
      } finally {
        setBusy(false);
        inputEl.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    appendMessage("bot", "Hei, jeg er Darleif Vederås spør i vei om partiet mitt.");
  </script>
</body>
</html>
